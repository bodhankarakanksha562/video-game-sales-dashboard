<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Game Sales - API Frontend</title>
    <link rel="stylesheet" href="data.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="card">
        <h1>ðŸŽ® Video Game Sales Explorer</h1>
        <p>Interactive frontend powered by REST API</p>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card">
                <h3>Total Games</h3>
                <div id="totalGames">-</div>
            </div>
            <div class="summary-card">
                <h3>Total Sales</h3>
                <div id="totalSales">-</div>
            </div>
            <div class="summary-card">
                <h3>Average Sales</h3>
                <div id="avgSales">-</div>
            </div>
            <div class="summary-card">
                <h3>Top Genre</h3>
                <div id="topGenre">-</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <input type="text" id="searchInput" class="searchbar" placeholder="Search games..." onkeyup="filterGames()">
            <select id="genreFilter" onchange="filterGames()">
                <option value="">All Genres</option>
            </select>
            <select id="platformFilter" onchange="filterGames()">
                <option value="">All Platforms</option>
            </select>
            <input type="number" id="yearMin" placeholder="Min Year" onchange="filterGames()" min="1980" max="2025">
            <input type="number" id="yearMax" placeholder="Max Year" onchange="filterGames()" min="1980" max="2025">
        </div>

        <!-- Charts -->
        <div class="charts-container">
            <div class="chart-wrapper">
                <canvas id="genreChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <canvas id="yearChart"></canvas>
            </div>
        </div>

        <!-- Games Table -->
        <table id="gamesTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Rank</th>
                    <th onclick="sortTable(1)">Name</th>
                    <th onclick="sortTable(2)">Platform</th>
                    <th onclick="sortTable(3)">Year</th>
                    <th onclick="sortTable(4)">Genre</th>
                    <th onclick="sortTable(5)">Publisher</th>
                    <th onclick="sortTable(6)">Global Sales</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="7" style="text-align: center;">Loading...</td>
                </tr>
            </tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination">
            <button onclick="prevPage()" id="prevBtn">Previous</button>
            <span id="pageInfo">Page 1</span>
            <button onclick="nextPage()" id="nextBtn">Next</button>
        </div>
    </div>

    <script>
        let allGames = [];
        let filteredGames = [];
        let currentPage = 1;
        let itemsPerPage = 50;
        let currentSort = { column: 0, ascending: true };

        // API Base URL
        const API_BASE = 'http://localhost:8000';

        // Initialize the app
        async function init() {
            try {
                await loadSummary();
                await loadFilters();
                await loadCharts();
                await loadGames();
            } catch (error) {
                console.error('Failed to initialize:', error);
                document.getElementById('tableBody').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; color: red;">Failed to load data. Make sure the API server is running.</td></tr>';
            }
        }

        // Load summary statistics
        async function loadSummary() {
            const response = await fetch(`${API_BASE}/summary`);
            const data = await response.json();

            document.getElementById('totalGames').textContent = data.total_games.toLocaleString();
            document.getElementById('totalSales').textContent = `${data.total_sales.toFixed(2)}M`;
            document.getElementById('avgSales').textContent = `${data.avg_sales.toFixed(2)}M`;
            document.getElementById('topGenre').textContent = data.top_genre;
        }

        // Load filter options
        async function loadFilters() {
            const [genresRes, platformsRes] = await Promise.all([
                fetch(`${API_BASE}/genres`),
                fetch(`${API_BASE}/platforms`)
            ]);

            const genres = await genresRes.json();
            const platforms = await platformsRes.json();

            const genreFilter = document.getElementById('genreFilter');
            const platformFilter = document.getElementById('platformFilter');

            genres.genres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreFilter.appendChild(option);
            });

            platforms.platforms.forEach(platform => {
                const option = document.createElement('option');
                option.value = platform;
                option.textContent = platform;
                platformFilter.appendChild(option);
            });
        }

        // Load charts
        async function loadCharts() {
            const [genreData, yearData] = await Promise.all([
                fetch(`${API_BASE}/analytics/sales-by-genre`).then(r => r.json()),
                fetch(`${API_BASE}/analytics/sales-by-year`).then(r => r.json())
            ]);

            // Genre chart
            const genreCtx = document.getElementById('genreChart').getContext('2d');
            new Chart(genreCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(genreData.sales_by_genre),
                    datasets: [{
                        label: 'Global Sales (M)',
                        data: Object.values(genreData.sales_by_genre),
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sales by Genre'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Year chart
            const yearCtx = document.getElementById('yearChart').getContext('2d');
            new Chart(yearCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(yearData.sales_by_year),
                    datasets: [{
                        label: 'Global Sales (M)',
                        data: Object.values(yearData.sales_by_year),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sales by Year'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Load games data
        async function loadGames() {
            const response = await fetch(`${API_BASE}/games?limit=1000`);
            allGames = await response.json();
            filteredGames = [...allGames];
            renderTable();
        }

        // Filter games
        function filterGames() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const genre = document.getElementById('genreFilter').value;
            const platform = document.getElementById('platformFilter').value;
            const yearMin = document.getElementById('yearMin').value;
            const yearMax = document.getElementById('yearMax').value;

            filteredGames = allGames.filter(game => {
                const matchesSearch = !searchTerm || game.Name.toLowerCase().includes(searchTerm);
                const matchesGenre = !genre || game.Genre === genre;
                const matchesPlatform = !platform || game.Platform === platform;
                const matchesYearMin = !yearMin || (game.Year && game.Year >= parseInt(yearMin));
                const matchesYearMax = !yearMax || (game.Year && game.Year <= parseInt(yearMax));

                return matchesSearch && matchesGenre && matchesPlatform && matchesYearMin && matchesYearMax;
            });

            currentPage = 1;
            renderTable();
        }

        // Sort table
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = column;
                currentSort.ascending = true;
            }

            filteredGames.sort((a, b) => {
                let aVal = Object.values(a)[column];
                let bVal = Object.values(b)[column];

                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                if (aVal < bVal) return currentSort.ascending ? -1 : 1;
                if (aVal > bVal) return currentSort.ascending ? 1 : -1;
                return 0;
            });

            renderTable();
        }

        // Render table
        function renderTable() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredGames.slice(start, end);

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No games found</td></tr>';
                return;
            }

            pageData.forEach(game => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${game.Rank}</td>
                    <td>${game.Name}</td>
                    <td>${game.Platform}</td>
                    <td>${game.Year || 'N/A'}</td>
                    <td>${game.Genre}</td>
                    <td>${game.Publisher}</td>
                    <td>${game.Global_Sales.toFixed(2)}M</td>
                `;
                tbody.appendChild(row);
            });

            updatePagination();
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredGames.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        // Pagination functions
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredGames.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        // Initialize when page loads
        window.onload = init;
    </script>

    <style>
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .summary-card h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card div {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .chart-wrapper {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-wrapper canvas {
            max-height: 300px;
        }
    </style>
</body>
</html>